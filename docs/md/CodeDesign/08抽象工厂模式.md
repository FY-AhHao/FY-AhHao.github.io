> **æŠ½è±¡å·¥å‚æ¨¡å¼**ï¼šå›´ç»•ä¸€ä¸ªè¶…çº§å·¥å‚åˆ›å»ºå…¶ä»–å·¥å‚ï¼Œè¶…çº§å·¥å‚æ˜¯å…¶ä»–å·¥å‚çš„å·¥å‚ï¼ˆå¥—å¨ƒğŸ™„ï¼‰ï¼Œå…¶ä»–å·¥å‚å†ç”Ÿäº§å¯¹åº”çš„å®ä¾‹åŒ–å¯¹è±¡

æ¥è‡ªå°å‚…å“¥çš„ä¸€å¼ ç§’æ‡‚çš„å›¾

![image-20220327214527352](./assets/image-20220327214527352.png)

ä¸‹é¢æ˜¯æŠ½è±¡å·¥å‚çš„æ¡ˆä¾‹ï¼Œæ¡ˆä¾‹æ¼”ç¤ºçš„æ˜¯ä»è›®è’æ—¶æœŸè‡ªå»ºçš„redisæœåŠ¡ä¸æ–­è¿­ä»£å‡çº§è¿‡æ¸¡çš„ä»£ç æ¼”å˜è¿‡ç¨‹ï¼Œåœ¨è¿‡æ¸¡çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å…¼å®¹æ–°æ—§çš„ä»£ç ï¼Œå› ä¸ºä¸€äº›å…³é”®çš„ä¸šåŠ¡å¯èƒ½ä»ç„¶ä¾èµ–äºæ—§ç‰ˆçš„æœåŠ¡ï¼Œä¸èƒ½ç«‹åˆ»å‡çº§ã€‚

> éœ€è¦ç†è§£æ€æƒ³ï¼Œä¸æ˜¯ç”Ÿæ¬ç¡¬å¥—ï¼Œè¿™ä¸ªæ¡ˆä¾‹çœŸæ˜¯è®©æˆ‘å¤§å¼€çœ¼ç•Œï¼Œä»£ç ç«Ÿç„¶è¿˜èƒ½è¿™æ ·å†™ğŸ‘ğŸ‘ğŸ‘

[æºç åœ°å€](https://github.com/FY-AhHao/learning-code/tree/main/codeDesign/demo08)

è›®è’æ—¶æœŸredisæœåŠ¡

```java
//çœŸæ­£å¯¹å¤–æœåŠ¡çš„ç¼“å­˜æ¥å£
public interface ICacheService {

    String get(String key);

    void set(String key,String value);

    void set(String key, String value, long timeout, TimeUnit timeUnit);

    void del(String key);
}

//ç¼“å­˜æ¥å£å®ç°ç±»
public class CacheServiceImpl implements ICacheService {

    private RedisUtil redisUtil = new RedisUtil();

    @Override
    public String get(String key) {
        return redisUtil.get(key);
    }

    @Override
    public void set(String key, String value) {
        redisUtil.set(key, value);
    }

    @Override
    public void set(String key, String value, long timeout, TimeUnit timeUnit) {
        redisUtil.set(key, value,timeout,timeUnit);
    }

    @Override
    public void del(String key) {
        redisUtil.del(key);
    }
}
```

ç»è¿‡äº†ä¸€æ®µæ—¶é—´ï¼Œå…¬å¸å¯¹redisæœåŠ¡è¿›è¡Œäº†å‡çº§ï¼Œä½†æ˜¯æ—§çš„ç³»ç»Ÿæ— æ³•å¿«é€Ÿè¿‡æ¸¡ä½¿ç”¨æ–°çš„redisæœåŠ¡ï¼Œå› æ­¤æ–°çš„redisæœåŠ¡éœ€è¦å…¼å®¹è›®è’æ—¶æœŸçš„redisæœåŠ¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯èƒ½ä¼šæƒ³åˆ°ï¼Œåœ¨æ¥å£å‚æ•°æ·»åŠ ä¸€ä¸ªæ ‡è¯†æ¥è¯†åˆ«ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„redisæœåŠ¡ä¸å°±å¯ä»¥äº†å—ğŸ¤”ï¼Ÿ

```java
//æ¥å£å¢åŠ æ ‡è¯†
public interface ICacheService {

    String get(String key,int redisType);

    void set(String key,String value,int redisType);

    void set(String key, String value, long timeout, TimeUnit timeUnit,int redisType);

    void del(String key,int redisType);

}

//ä¿®æ”¹å®ç°ç±»
public class CacheClusterServiceImpl implements ICacheService {

    private RedisUtil redisUtil = new RedisUtil();

    private EGM egm = new EGM();


    @Override
    public String get(String key, int redisType) {
        if (redisType == 1){
            return egm.gain(key);
        }

        return redisUtil.get(key);
    }

    @Override
    public void set(String key, String value, int redisType) {
        if (redisType == 1){
            egm.set(key, value);
            return;
        }

        redisUtil.set(key, value);
    }

    @Override
    public void set(String key, String value, long timeout, TimeUnit timeUnit, int redisType) {
        if (redisType == 1){
            egm.setEx(key, value,timeout,timeUnit);
            return;
        }

        redisUtil.set(key, value,timeout,timeUnit);
    }

    @Override
    public void del(String key, int redisType) {
        if (redisType == 1){
            egm.delete(key);
            return;
        }

        redisUtil.del(key);
    }
}
```

ä½†æ˜¯ä¸‡ä¸€ä»¥åå†å‡çº§ï¼Œé‚£ä»£ç é‡Œé¢ä¸æ˜¯åˆè¦åŠ ä¸€å±‚ifåˆ¤æ–­ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„æœåŠ¡ï¼Ÿæ›´è®©äººä¸èƒ½æ¥å—çš„æ˜¯æ”¹åŠ¨åˆ°äº†æ–¹æ³•çš„å‚æ•°ï¼Œè°ƒç”¨æ–¹ä¹Ÿè¦è·Ÿç€æ”¹ï¼Œéå¸¸éº»çƒ¦ã€‚æœ‰æ²¡æœ‰æ›´åŠ ä¼˜é›…çš„åšæ³•ï¼Œå¯ä»¥ä¸æ”¹åŠ¨æ¥å£çš„æƒ…å†µä¸‹ï¼Œä»¥æœ€å°çš„ä»£ä»·æ›¿æ¢æœåŠ¡å‘¢ï¼Ÿè¿™é‡Œä½¿ç”¨æŠ½è±¡å·¥å‚çš„æ€æƒ³ï¼ŒåŠ ä¸Šé€‚é…å™¨å’Œä»£ç†æ¥å®ç°

```java
//ç¼“å­˜æœåŠ¡é€‚é…å™¨
public interface ICacheAdapter {

    String get(String key);

    void set(String key,String value);

    void set(String key, String value, long timeout, TimeUnit timeUnit);

    void del(String key);

}

//é€‚é…ç¬¬ä¸€æ¬¡å‡çº§çš„æœåŠ¡
public class EGMCacheAdapter implements ICacheAdapter {

    private EGM egm = new EGM();

    @Override
    public String get(String key) {
        return egm.gain(key);
    }

    @Override
    public void set(String key, String value) {
        egm.set(key, value);
    }

    @Override
    public void set(String key, String value, long timeout, TimeUnit timeUnit) {
        egm.setEx(key, value, timeout, timeUnit);
    }

    @Override
    public void del(String key) {
        egm.delete(key);
    }
}

//é€‚é…ç¬¬äºŒæ¬¡å‡çº§çš„æœåŠ¡
public class IIRCacheAdapter implements ICacheAdapter {

    private IIR iir = new IIR();

    @Override
    public String get(String key) {
        return iir.get(key);
    }

    @Override
    public void set(String key, String value) {
        iir.set(key, value);
    }

    @Override
    public void set(String key, String value, long timeout, TimeUnit timeUnit) {
        iir.setExpire(key, value, timeout, timeUnit);
    }

    @Override
    public void del(String key) {
        iir.remove(key);
    }
}

//æŠ½è±¡å·¥å‚
public class JDKProxyFactory {
  
    //ç†è§£ä¸ºè¶…çº§å·¥å‚ç”Ÿäº§ICacheServiceå·¥å‚ï¼ŒICacheServiceå·¥å‚ç”Ÿäº§ICacheAdapterå®ä¾‹åŒ–å¯¹è±¡
    public static <T> T getProxy(Class<T> clazz, Class<? extends ICacheAdapter> cacheAdapter) throws Exception {
        JDKInvocationHandler invocationHandler = new JDKInvocationHandler(cacheAdapter.newInstance());
        ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();
        return (T) Proxy.newProxyInstance(contextClassLoader,new Class[]{clazz},invocationHandler);
    }

}


public class JDKInvocationHandler implements InvocationHandler {

    private ICacheAdapter cacheAdapter;

    public JDKInvocationHandler(ICacheAdapter cacheAdapter) {
        this.cacheAdapter = cacheAdapter;
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        return ICacheAdapter.class.getMethod(method.getName(),method.getParameterTypes()).invoke(cacheAdapter,args);
    }
}
```

ç»è¿‡æŠ½è±¡å·¥å‚æ¨¡å¼æ”¹é€ ä»¥åï¼Œè°ƒç”¨æ–¹åªéœ€è·å–è‡ªå·±éœ€è¦çš„æœåŠ¡å®ä¾‹åŒ–å¯¹è±¡å³å¯(ä½¿ç”¨spirngæ¡†æ¶åï¼Œåªéœ€è¦å¾€å®¹å™¨ä¸­æ³¨å…¥ç›¸åº”çš„å¯¹è±¡å³å¯)ï¼Œå› ä¸ºæ¥å£æ²¡æœ‰åšæ”¹åŠ¨ï¼Œæ— éœ€ä¿®æ”¹å…¶ä»–ä¸šåŠ¡ä»£ç ã€‚

```java
public class ApiTest {

    public static void main(String[] args) throws Exception {
        ICacheService cacheService = new CacheServiceImpl();
        cacheService.set("hello","origin cache service");
        cacheService.get("hello");

        ICacheService egm = JDKProxyFactory.getProxy(ICacheService.class, EGMCacheAdapter.class);
        egm.set("hello","egm service");
        egm.get("hello");

        ICacheService iir = JDKProxyFactory.getProxy(ICacheService.class, IIRCacheAdapter.class);
        iir.set("hello","iir service");
        iir.get("hello");
    }
}
```

